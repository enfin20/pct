<script>
  import {
    MM_YYYY,
    date_YYYYMM,
    date_DD_MM,
    MM,
    YYYYMM,
    date_YYYYMMDD,
  } from "$lib/date_functions";
  import { IDB } from "$lib/IDB";
  export let roadbook;
  export let sourceDB;

  var buttonLabel = "Add";
  var edit_Day = Object();
  edit_Day._id = "";
  edit_Day.day = "";
  edit_Day.start = "";
  edit_Day.end = "";
  edit_Day.weather = -1;
  edit_Day.difficulty = -1;
  edit_Day.night = -1;
  edit_Day.landscape = -1;
  edit_Day.detail = "";

  let weatherIcon = [
    "Snow",
    "Rain",
    "Fog",
    "Wind",
    "Thunder",
    "Cloud",
    "SemiSun",
    "Sun",
  ];
  let nightIcon = ["Star", "Bivouac", "Camp", "Hotel", "Free"];
  let imgNewWeatherActivate = [
    "_in",
    "_in",
    "_in",
    "_in",
    "_in",
    "_in",
    "_in",
    "_in",
  ];
  let difficultyIcon = ["ZeroDay", "Star", "Star", "Star"];
  let starsIcon = ["Star", "Star", "Star"];
  let imgNewDifficultyActivate = ["_in", "_in", "_in", "_in"];
  let imgNewNightActivate = ["_in", "_in", "_in", "_in", "_in"];
  let imgNewLandscapeActivate = ["_in", "_in", "_in"];
  // _in rgb(200,225,200)

  import { createEventDispatcher } from "svelte";
  import { subscribe } from "svelte/internal";

  const dispatch = createEventDispatcher();

  function showRoadbook() {
    dispatch("showRoadbook");
  }

  function updateIcons() {
    //mise à jour des icones
    for (var i = 0; i < weatherIcon.length; i++) {
      if (edit_Day.weather === i) {
        imgNewWeatherActivate[i] = "";
      } else {
        imgNewWeatherActivate[i] = "_in";
      }
    }

    for (var i = 0; i < difficultyIcon.length; i++) {
      if (edit_Day.difficulty === 0) {
        // zero day
        imgNewDifficultyActivate[0] = "";
        imgNewDifficultyActivate[i] = "_in";
      } else if (edit_Day.difficulty >= i) {
        imgNewDifficultyActivate[0] = "_in";
        imgNewDifficultyActivate[i] = "";
      } else {
        imgNewDifficultyActivate[i] = "_in";
      }
    }
    for (var i = 0; i < nightIcon.length; i++) {
      if (edit_Day.night === i) {
        imgNewNightActivate[i] = "";
      } else {
        imgNewNightActivate[i] = "_in";
      }
    }

    for (var i = 0; i < starsIcon.length; i++) {
      if (edit_Day.landscape >= i) {
        imgNewLandscapeActivate[i] = "";
      } else {
        imgNewLandscapeActivate[i] = "_in";
      }
    }
  }

  function cleanForm() {
    console.log("clean form");
    edit_Day._id = "";
    buttonLabel = "Add";
    edit_Day.day = "";
    edit_Day.start = "";
    edit_Day.end = "";
    edit_Day.weather = -1;
    edit_Day.difficulty = -1;
    edit_Day.night = -1;
    edit_Day.landscape = -1;
    edit_Day.detail = "";

    buttonLabel = "Add";
    updateIcons();
  }

  export async function editDay(r_id) {
    console.log("r_id:", r_id);
    if (sourceDB === "MDB") {
      // recupération depuis MongoDB
      let res = await fetch("/roadbook/day?id=" + r_id);
      const rday = await res.json();
      edit_Day = await rday.r_day;
      console.info("edit_Day:", edit_Day);
    } else {
      // recupération depuis IndexedDB
      edit_Day = await IDB.Roadbook.where({ day: r_id }).first();
    }
    edit_Day._id = r_id;
    edit_Day.day = [
      edit_Day.day.substring(0, 4),
      edit_Day.day.substring(4, 6),
      edit_Day.day.substring(6, 8),
    ].join("-");

    buttonLabel = "Update";

    //mise à jour des icones
    updateIcons();
  }

  export async function insertRoadbook() {
    let new_id = "";
    var res = new Object();
    edit_Day.day = edit_Day.day
      .substring(0, 4)
      .concat(edit_Day.day.substring(5, 7))
      .concat(edit_Day.day.substring(8, 10));
    edit_Day.weather = Number(edit_Day.weather);
    edit_Day.difficulty = Number(edit_Day.difficulty);
    edit_Day.night = Number(edit_Day.night);
    edit_Day.landscape = Number(edit_Day.landscape);
    console.info("edit_Day:", edit_Day);
    if (edit_Day._id === "") {
      // Insert new day
      if (sourceDB === "MDB") {
        // insertion dans MongoDB
        res = await fetch("/roadbook/day", {
          method: "POST",
          body: JSON.stringify(edit_Day),
        });
        new_id = await res.json();
        edit_Day._id = edit_Day.day;
      } else {
        // insertion dans IndexedDB
        new_id = await IDB.Roadbook.add({
          day: edit_Day.day,
          weather: Number(edit_Day.weather),
          difficulty: Number(edit_Day.difficulty),
          night: Number(edit_Day.night),
          landscape: Number(edit_Day.landscape),
          detail: edit_Day.detail,
          start: edit_Day.start,
          end: edit_Day.end,
        });
        edit_Day._id = edit_Day.day;
      }

      // remise à jour du tableau
      roadbook.unshift({
        day: edit_Day.day,
        start: edit_Day.start,
        end: edit_Day.end,
        _id: edit_Day.day,
        weather: edit_Day.weather,
        difficulty: edit_Day.difficulty,
        night: edit_Day.night,
        landscape: edit_Day.landscape,
        detail: edit_Day.detail,
      });
      roadbook = roadbook;
    } else {
      // update new day
      if (sourceDB === "MDB") {
        // MAJ MongoDB
        res = await fetch("/roadbook/day", {
          method: "PUT",
          body: JSON.stringify(edit_Day),
        });
      } else {
        // MAJ IndexedDB
        IDB.Roadbook.update(edit_Day._id, {
          day: edit_Day.day,
          weather: Number(edit_Day.weather),
          difficulty: Number(edit_Day.difficulty),
          night: Number(edit_Day.night),
          landscape: Number(edit_Day.landscape),
          detail: edit_Day.detail,
          start: edit_Day.start,
          end: edit_Day.end,
        });
      }
    }
    //mise à jour du tableau
    for (var i = 0; i < roadbook.length; i++) {
      if (roadbook[i].day === edit_Day.day) {
        roadbook[i].weather = Number(edit_Day.weather);
        roadbook[i].difficulty = Number(edit_Day.difficulty);
        roadbook[i].night = Number(edit_Day.night);
        roadbook[i].landscape = Number(edit_Day.landscape);
        roadbook[i].detail = edit_Day.detail;
        roadbook[i].start = edit_Day.start;
        roadbook[i].end = edit_Day.end;
      }
    }
    cleanForm();
    showRoadbook();
  }
</script>

<div class="py-2 grid gap-1">
  <div class="grid grid-cols-1 place-content-center w-full">
    <form class="w-full " on:submit|preventDefault={insertRoadbook}>
      <div class=" w-full  flex flex-wrap -mx-3 mb-6">
        <div class="w-full md:w-1/3 px-3 mb-6 md:mb-0">
          <label
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            for="grid-first-name"
          >
            Date
          </label>
          <input
            type="date"
            bind:value={edit_Day.day}
            class=" appearance-none block w-full bg-gray-100 text-gray-600 border border-gray-300 rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white"
            on:click={updateIcons}
          />
        </div>
        <div class="w-full md:w-1/3 px-3 mb-6 md:mb-0">
          <label
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            for="grid-first-name"
          >
            Start
          </label>
          <input
            type="text"
            bind:value={edit_Day.start}
            class=" appearance-none block w-full bg-gray-100 text-gray-600 border border-gray-300 rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white"
          />
        </div>
        <div class="w-full md:w-1/3 px-3 mb-6 md:mb-0">
          <label
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            for="grid-first-name"
          >
            End
          </label>
          <input
            type="text"
            bind:value={edit_Day.end}
            class=" appearance-none block w-full bg-gray-100 text-gray-600 border border-gray-300 rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white"
          />
        </div>
      </div>
      <div class="flex flex-wrap -mx-3 mb-2">
        <div class="w-full px-3 mb-6 md:mb-0">
          <label
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            for="grid-first-name"
          >
            Weather
          </label>
          {#each weatherIcon as wi, i}
            <input
              type="radio"
              bind:group={edit_Day.weather}
              name="r_weather"
              value={i}
              id="r_weather{i}"
              class="peer hidden"
              on:change={updateIcons}
            />
            <label
              for="r_weather{i}"
              class="select-none cursor-pointer  py-1 px-1 font-bold text-slate-400 transition-colors duration-200 ease-in-out  "
            >
              <img
                src="https://www.orientsport.fr/oflash/img/{wi}{imgNewWeatherActivate[
                  i
                ]}.png"
                alt=""
                class="w-[35px] inline"
              /></label
            >
          {/each}
        </div>
      </div>
      <div class="flex flex-wrap -mx-3 mb-2">
        <div class="w-full md:w-1/2 px-3 mb-6 md:mb-0">
          <label
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            for="grid-first-name"
          >
            Difficulty
          </label>
          {#each difficultyIcon as di, i}
            <input
              type="radio"
              bind:group={edit_Day.difficulty}
              name="r_difficulty"
              value={i}
              id="r_difficulty{i}"
              class="peer hidden"
              on:change={updateIcons}
            />
            <label
              for="r_difficulty{i}"
              class="select-none cursor-pointer py-1 px-1 font-bold text-slate-400 transition-colors duration-200 ease-in-out "
            >
              <img
                src="https://www.orientsport.fr/oflash/img/{di}{imgNewDifficultyActivate[
                  i
                ]}.png"
                alt=""
                class="w-[40px] inline"
              /></label
            >
          {/each}
        </div>
        <div class="w-full md:w-1/2 px-3 mb-6 md:mb-0">
          <label
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            for="grid-first-name"
          >
            Night
          </label>
          {#each nightIcon as ni, i}
            <input
              type="radio"
              bind:group={edit_Day.night}
              name="r_night"
              value={i}
              id="r_night{i}"
              class="peer hidden"
              on:change={updateIcons}
            />
            <label
              for="r_night{i}"
              class="select-none cursor-pointer py-1 px-1 font-bold text-slate-400 transition-colors duration-200 ease-in-out "
            >
              <img
                src="https://www.orientsport.fr/oflash/img/{ni}{imgNewNightActivate[
                  i
                ]}.png"
                alt=""
                class="w-[40px] inline"
              /></label
            >
          {/each}
        </div>
      </div>
      <div class="flex flex-wrap -mx-3 mb-2">
        <div class="w-full px-3 mb-6 md:mb-0">
          <label
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            for="grid-first-name"
          >
            Landscape
          </label>
          {#each starsIcon as si, i}
            <input
              type="radio"
              bind:group={edit_Day.landscape}
              name="r_landscape"
              value={i}
              id="r_landscape{i}"
              class="peer hidden"
              on:change={updateIcons}
            />
            <label
              for="r_landscape{i}"
              class="select-none cursor-pointer py-1 px-1 font-bold text-slate-400 transition-colors duration-200 ease-in-out "
            >
              <img
                src="https://www.orientsport.fr/oflash/img/{si}{imgNewLandscapeActivate[
                  i
                ]}.png"
                alt=""
                class="w-[40px] inline"
              /></label
            >
          {/each}
        </div>
      </div>
      <div class="flex flex-wrap -mx-3 mb-2">
        <div class="w-full px-3 mb-6 md:mb-0">
          <label
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            for="grid-first-name"
          >
            Details
          </label>
          <textarea
            bind:value={edit_Day.detail}
            class=" w-full appearance-none border-2 border-gray-200 rounded py-2 px-4 text-gray-700 leading-tight focus:outline-none"
            rows="20"
          />
        </div>
      </div>
      <div class="flex flex-wrap -mx-3 mb-2">
        <div class="w-full md:w-1/2 px-3 mb-6 md:mb-0">
          <button
            class="bg-red-300 hover:bg-red-400 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
            on:click={cleanForm}
          >
            Clear
          </button>
        </div>
        <div class="w-full md:w-1/2 px-3 mb-6 md:mb-0">
          <button
            class="bg-teal-500 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
          >
            {buttonLabel}
          </button>
        </div>
      </div>
    </form>
  </div>
  <table id="rdb" class="text-sm text-gray-500 w-full relative">
    <tbody class="">
      {#each roadbook as r}
        <tr
          class="align-middle text-center border-collapse border-t-[1px] border-slate-200"
        >
          <td class="text-left align-middle py-1 px-1 ">
            {r.day.substring(6, 8).concat("/").concat(r.day.substring(4, 6))}
          </td>
          <td class="text-left align-middle py-1 px-1 ">
            <img
              src="https://www.orientsport.fr/oflash/img/{weatherIcon[
                r.weather
              ]}.png"
              alt=""
              class="w-[30px] inline"
            />
          </td>
          <td class="text-left align-middle py-1 px-1 ">
            {#each difficultyIcon as di, i}
              {#if i === 0}
                {#if r.difficulty === 0}
                  <img
                    src="https://www.orientsport.fr/oflash/img/{difficultyIcon[
                      i
                    ]}.png"
                    alt=""
                    class="w-[20px] md:w-[30px] inline"
                  />
                {:else}
                  <img
                    src="https://www.orientsport.fr/oflash/img/{difficultyIcon[
                      i
                    ]}_in.png"
                    alt=""
                    class="w-[20px] md:w-[30px] inline"
                  />
                {/if}
              {:else if r.difficulty >= i}
                <img
                  src="https://www.orientsport.fr/oflash/img/{difficultyIcon[
                    i
                  ]}.png"
                  alt=""
                  class="w-[20px] md:w-[30px] inline"
                />
              {:else}
                <img
                  src="https://www.orientsport.fr/oflash/img/{difficultyIcon[
                    i
                  ]}_in.png"
                  alt=""
                  class="w-[20px] md:w-[30px] inline"
                />
              {/if}
            {/each}
          </td>
          <td class="text-left align-middle py-1 px-1 ">
            <img
              src="https://www.orientsport.fr/oflash/img/{nightIcon[
                r.night
              ]}.png"
              alt=""
              class="w-[30px] inline"
            />
          </td>
          <td class="text-left align-middle py-1 px-1 ">
            {#each starsIcon as si, i}
              {#if r.landscape >= i}
                <img
                  src="https://www.orientsport.fr/oflash/img/{starsIcon[0]}.png"
                  alt=""
                  class="w-[20px] md:w-[30px] inline"
                />
              {:else}
                <img
                  src="https://www.orientsport.fr/oflash/img/{starsIcon[0]}_in.png"
                  alt=""
                  class="w-[20px] md:w-[30px] inline"
                />
              {/if}
            {/each}
          </td>
          <td class="align-middle py-1 px-1 w-[5%]">
            <button
              class="bg-teal-500 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
              id={r._id}
              on:click={editDay(r._id)}>Edit</button
            >
          </td>
        </tr>
      {/each}
    </tbody>
  </table>
</div>
